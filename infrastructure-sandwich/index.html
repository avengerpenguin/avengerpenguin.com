<!DOCTYPE html>
<html lang="en">
<head>
      <title>Infrastructure Sandwich | Ross Fenning's Digital Garden</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://avengerpenguin.com/infrastructure-sandwich/" />
    <meta property="og:title" content="Ross Fenning's Digital Garden - Infrastructure Sandwich" />
    <meta property="og:description" content="There is a difficulty that arises, I have noted, when a distinct tool or pipeline step is used to deploy application code compared to deploying infrastructure. If we are doing..." />

    <link href="https://avengerpenguin.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Ross Fenning's Digital Garden Full Atom Feed" />


  <meta name="description" content="There is a difficulty that arises, I have noted, when a distinct tool or pipeline step is used to deploy application code compared to deploying infrastructure. If we are doing infra-structure-as-code or GitOps it is likely we have our infrastructure in the same repository as the application that runs on â€¦" />


    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="theme-color" content="#ffffff">



    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QCZXQLVK2B"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-QCZXQLVK2B');
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7863038150136152"
            crossorigin="anonymous"></script>



    <link rel="stylesheet" href="https://avengerpenguin.com/theme/css/awsm.css" />

        <link rel="stylesheet" href="https://avengerpenguin.com/theme/css/common.min.css?64950869">

        <link rel="stylesheet" href="https://avengerpenguin.com/theme/css/style.min.css?5a44924b">


</head>

<body>
    <header>
        <h1><a href="https://avengerpenguin.com/">Ross Fenning's Digital Garden</a></h1>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/blog/">Blog</a></li>
                <li><a href="/search/">Search</a></li>
            </ul>
        </nav>
    </header>
	<main>
    <h1>Infrastructure Sandwich</h1>
    

    <p>There is a difficulty that arises, I have noted, when a distinct tool or pipeline step is used to deploy application code compared to deploying infrastructure.</p>
<p>If we are doing infra-structure-as-code or GitOps it is likely we have our infrastructure in the same repository as the application that runs on it. It is also likely we deploy that infrastructure via Terraform or a vendor-specific tool like AWS Cloudformation.</p>
<p>However, teams may choose to do <em>application</em> deployment on that infrastructure via <code>kubectl</code> in the case of Kubernetes. Maybe we have a serverless application that we deploy via a framework's own CLI tool.</p>
<h2 id="the-sandwich">The Sandwich</h2>
<p>So we likely need a deployment pipeline that looks roughly like:</p>
<p><img src="data:image/png;base64,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" class="uml" alt="uml diagram" title="" /></p>
<p>However if we take the Kubernetes use case, we the "App" deployment will include things like ingress. If we have used the ALB Controller to create an AWS load balancer, we can't deploy any infra attached to that until after it is created. Therefore maybe we want:</p>
<p><img src="data:image/png;base64,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" class="uml" alt="uml diagram" title="" /></p>
<p>But this is clearly wrong if we want to provision infrastructure the app needs like a Redis cache or database before the application is deployed.</p>
<p>So the "Infrastructure Sandwich" emerges as a naive solution to the problem:</p>
<p><img src="data:image/png;base64,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" class="uml" alt="uml diagram" title="" /></p>
<p>That is, we have two deployments for infrastructure. Firstly we deploy the base infrastructure needed for the application, then the application and finally we can deploy additional infra like alarms or logging that rely on knowing things created by the application stage.</p>
<h2 id="the-problem">The Problem</h2>
<p>The most obvious problem is that the pipeline above just looks clunky. It doesn't seem elegant to have this sandwich of deployment steps and that inelegance is telling us something about our design and abstractions, I think.</p>
<p>A more tangible issue is we have lost potential atomicity of our deployments. That is, if we deploy everything through a single AWS Cloudformation update (a feature of AWS SAM) then Cloudformation handles:</p>
<ol>
<li>Making the change appear as a single operation</li>
<li>Doing internal steps in an appropriate order to avoid bad state</li>
<li>Halting and rolling back the transaction if an unexpected error occurs</li>
</ol>
<p>Tools like Terraform do not tend to roll back as such, but there is an atomicity of the "plan" phase where we have old state, desired new state and it plans all the steps to get from one to another in a single operation from the perspective of the caller.</p>
<h2 id="but-people-dont-always-notice-it">But people don't always notice it</h2>
<p>There's a particular tricky aspect to this problem that makes it hard to notice it. In fact, reading this you may be thinking this isn't a big problem or an edge case. One of the things that hides this problem is if we build a pipeline like the first one above:</p>
<p><img src="data:image/png;base64,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" class="uml" alt="uml diagram" title="" /></p>
<p>as a first pass. That is perfectly sufficient to bootstrap base infra (EC2, Kubernetes) and deploy to it. Then later we can add databases, caches, etc. and it will work. And then one day we add an alarm attached to a load balancer, say, and <em>it will work</em>.</p>
<p>The truth is if applying deltas to existing infrastructure, we can easily attach stuff to existing load balancers and other things owned by the "app" deployment phase because those things in place.</p>
<p>But can you redeploy all this from scratch in case of disaster recovery?</p>
<p>What will happen if all the infra is lost and we run <code>terraform plan</code> for the first time, it will abort because it's trying to attach infrastructure to things that do not exist yet.</p>
<p>This is such a hard thing to notice and get right but I have seen countless cases where infra-as-code and continuous deployment is reliant on the fact we haven't ever actually torn it all down and verified it will all come back up without some chicken-and-egg paradox.</p>
<h2 id="causes">Causes</h2>
<p>There's a few places I have seen this arise:</p>
<ol>
<li>Where Kubernetes is used on a cloud vendor and you want to let it create <em>some</em> infra like ingress (and AWS ALB vis the ALB controller) but you want to attach alarms to that ALB.</li>
<li>Where an internal platform tool was used to create Amazon Machine Images (AMI) and upload them to an existing AWS Autoscaling Group (ASG). The presumption was you had handled an infra deployment phase beforehand.</li>
<li>Any case where deployment is a little bit more manual, e.g. I create infra, deploy via git, FTP, SCP, then add some more infra. In these cases it's normally so manual people don't even have a pipeline in which the sandwich appears.</li>
<li>Cases where a serverless framework (e.g. serverless) is used where it has built-in deployment commands that are limited to creating the function and uploading the latest code. In these cases we still need infra deployments either side.</li>
</ol>
<h2 id="solution">Solution</h2>
<p>While the two-phase infra deployment will do it, it's hinting we have our abstraction wrong. In my mind this is where encapsulation comes in. The naive pipelines above are based on a domain model along the lines of:</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAksAAABvCAIAAABzfRNcAAAXpklEQVR4Xu2dCXgNZ9vHU/vSvmqnagtt0SrdY29IpGhTVVVUFy9fUerTt9rqEi2vRrdQfYuq3UsqITlZSCIkgggSEZUIUpyKEIQsJJFF4rtjdL7TZ86ZmZwZkXnO/3f9r1xznu08930/z9wzZ4vTTQAAAIBHnNgCAAAAgAuQ4QAAAPAJMhwAAAA+QYYDAADAJ8hwAAAA+AQZDgAAAJ8gwwEAAOATZDgAAAB8ggwHAACAT5DhAAAA8AkyHAAAAD5BhgMAAMAnyHAAAAD4BBkOAAAAnyDDAQAA4BNkOAAAAHyCDAcAAIBPkOEAAADwCTIcAAAAPkGGMzBOTnaGz1ZHW+UAAGBEcEYzMJVNSGJ7Wx1tlQMAgBHBGc3A2J2QbHW0VQ4AAEYEZzQDY3dCstXRVjkAABgRnNEMDCWkxYsXOzs7N23adOrUqcXFxWK5cFB4Piv3yEl6aF6zhSQ9SFsR9OagYfff948Obdr++O/5yHAAAJ7AGc3AUEJyc3PLyMg4EXew3+NPvTfgpQPvzI1xn0blIQ++uNHp2aBWQ8K7j6GHVE6SHkzs6fpMa2f/Xm/6PjHq8XrNqJx6BbceGtpxePTzk+Mnfp36zdqzm6NzDqeV5heyTw8AANUbZDjjUVZckn3o+OmVIZSQVj09KqDRwJC2L61zfadt4+Z0W5a5bT+VF6RfENuLd2bSg06dOh09elQ4Tk5OFsrpzu/aqYwLUQknl5kOf/RT7CsfU5rcVL8fZb6o/pMS3vVO+49/9sFjNA2hIwAAVE+Q4QzDlYTUVO810a5TNjccENHjjf1vfkkJ6UxYbHH2Vaq9fv16vXr1hJbMi43SxCYeUBfqKBzTAdORoTDj0sXogyeXBiRMmh/Rc9ymBv23PfVW4vs/UFrNTT7JtgYAgLuN3BkN3HXoVozu1eJGfx7Y1D2s2+uHZiw4H7b3RsHtnEQJKTU1VTimWzG6IROOKW8VFBQIx5mZmdLEZnkPJ46QkpIin+EYbhQWXY47cuLHjXFjvtj68MjN9z0fM/j9Y9/9N+dwGtsUAADuBpU4o4GqoTS/8NyWWLo3CusyytTcY99Yr9OrQ+n+iW13K1F5eHhk3GLw4MGzZ88Wyvv06TNnzpz8/PzTp097enpKE5t44OXlJY7g5uZWqQzHUJJzNSN4d+LU7yjbBbXw2PfGbFvTBgCAqsH+MxrQl6KsnFPLg3YOmko3Q/Q39Zu12YnH2UZ/x+nWZyk7duzYpEmTKVOmFBUVCeXJyckuLi4NGjTo2rXrunXrpIlNPKAukydPpu7Ozs5Lly7VkuEsKTiTeWpFMN16mpoNDus6KumDhZd2J90sL2fbAQDAnUSfMxqwm9uJzW1aQKOBcWO+OBsQLb4IyQfZB4+lzF0R0XNccOuhCZO/uRCVUH6jjG0EAAB3AGS4u0Px5Vy6y/lbYiu8fQfGK9dOZdCN6fbnxtONXfyEeZkR+/BpTADAHQUZrkoREluM+63ENvrzs5v5T2xSCs5knlj4W1S/dwObuB1877sr8be/rgAAAPqCDFcVlN8oO791b+yITwLuH0SJLX1TlAMmNikFZy8enbdqS+cR4Y+OPvb9+uuZl9kWAACgAWS4O0u++fyRL34JbjNsu8s/Ty0PKr2GXwaxQtaew/ET5gU2HrT7pQ/PBkTj1UsAgC4gw90RyoqKz/wWudNtmqm5R9IHC3NTTrEtgIQbBdfNa7dGu04JauHx+6eL8U0DAIBGkOF0JudwWuL7P5iaDY7xmJ7uvwO3I3ZwNS390P/6BDZ13zty1qVdh9hqAABQBzKcPtBN2+mVIZFPvx3SzjPlq+UFZzLZFqCSlOYX/rF4U1jXURE93jj1qwnvXAIAKgsynFauZ15O9loW1PKF3cM+OB8eh+81605m5IE9L880Nff4/ZOf8WkUAIB6kOHsJ/vQ8f1vfRXYeFDi1O+unjjDVgNdyTefPzTdh7ydMPmbayfPstUAACABGa7SlN8oOxu4M6r/pJB2nse+X1+SU/HT/qBqKMrKoTtmup+LG/15zu9/sNUAAGABMlwlKMm9dnyBb2jH4Tt6T0zfFIVfn7pblF4rPO6zIfiBobuGzqj4xUsAALAGMpwqrmdeTvrXj4FN3PaN9bqScPvfzYC7S1lxyanlQVsfejXadUpW7GG2GgDg8CDDKZBvPn/wve8CGw9K+mBh4bksthrcbehO+vTqULqxjvGYjh8AAwBYggxnk6vH/zzwzlxTs8FHPltSlJXDVoPqRFlJ6cllppC2L+3x/BD/ghUAIIAMZ4Wc3//YO+qzoBYeR+etwgdJDERZUXHaT37BrYfufe3TvGNmthoA4GAgw/2NKwdS6CaATpHHfTaU5uM3JA3JjcKiY9+vpwuUhEnzr1/MZqsBAA4DMtxtLu9LjnGfFtrh5T+WbKZbAbYaGI3i7KuHZy4KbOqeMncFZ/9UFgCgEmS4m7lHTu5+6cOQdp6nVgSXlZSy1cDI5J8+Fzfmi+A2w06vDCkvw7c7AHAsHDrDXfvj7L6xXkGthpxYtBE/kcwxV+KPRg2YHN59zIXtB9g6AAC/OGiGKzh7Mf5/vE3NPY5+vRrvtzkIGUG7tnQaETvik3zzebYOAMAjDpfhii5lC9/dPvLZkuJsfE7SsaA79aPzVgU2dU/+8lf8swIAuMeBMlzp1YLk2cvo7Jb4/g/4iJ0jQ3fwcaM/D23vmb4piq0DAHCEQ2S48htlp5YHBbceuv/tOfl/4j+3gQou7ToU8fjYnYOmyvxfiJK8fLYIAGAc+M9wmZEHwruPiX5+cvah42wdcGzo0ufEoo2mZoOTv/zV6keNcpNPmtdsYUsBAAaB5wyXl2reNXTG1odHZgTtYusA+IvCjEuxr35C6+Ri9EGmitJewD8GUp5jygEAhoDPDFeUlXNwyrdBLTxO/LgRX3EDajgXuie0vef+t74quvS392jDurwW/MAwfGccACPCW4aji+5j364zNfc4NGMBPioJKkVpfuHhj36iCyPz2q1i4d6Rs/zr9I57/XOLhgAAY8BVhjsfHrel84g9wz+6mpbO1gGgjpykE9uefHPXkBkF6RfoYfLsZeGPjQ5sNBBvyAFgODjJcPl/ZlJiC+syCj9aAbRTXnoj1XuNqbnHyaUB6RsjI3q8sdHp2YBGg/KOnmabAgCqMYbPcBXf4f33yqCWLxz7fj3ecgM6kpdq3t5rQuQzbwe3GUYZLrjlC+HdXscbcgAYCGNnuPPhcVsfenXfG7OvZ15m6wCwl7Ki4ovRiYnTfSJd/rmpfj9Kb4Iieo478M5ctjUAoLpi1AyX/2dm7Csfh3UZdXFnIlsHgF3km8+f/CVw94v/8q/dW8xqfrV6icdUHtxqCN6QA8AosBkuJydnZ/UnItK/xeAtE2dHb9+Rm5vLmKA7xvAJ11R9lHf4B0X+8t8I7yVhM78Nff0j0zPjNrd/0e++AX71+/rV67tjjZ9lY0NQ9T4EVYkjx1fGdjbDUWsnI1DHqYZwEBMTw5igO0bxCcdUtyjXd6rJFlV7qpsPgb44cnxlbLee4RYunLlz5/JqrgULZsrbphcG8gl/QpS1Cz7kW44cX0XbrWc46llefqiaKzr6V3nb9MJAPuFPiLJ2wYd8y5Hjq2i74TOct7d3VFRUfHx8WlpaVlYWY44uGMgn/AlR1i74kG85cnwVbTd8hvPy8jKZTGReUlLSuXPnGHN0wUA+4U+IsnbBh3zLkeOraLvhM9ysWbN8fX1DQkLi4uLMZjNjji4YyCf8CVHWLviQbzlyfBVt5yHDrV271t/fnxI43aIy5uiCgXzCnxBl7YIP+ZYjx1fRdmQ4ZQzkE/6EKGsXfMi3HDm+irYjwyljIJ/wJ0RZu+BDvuXI8VW0HRlOGQP5hD8hytoFH/ItR46vou3IcMoYyCf8CVHWLviQbzlyfBVtR4ZTxkA+4U+IsnbBh3zLkeOraPtdznD0XNJClVK0TS/08klgoM+DD7bUYrJeqg5zEKQ4E8NFubKqglXBvQ/vhO5oRColxZkYLr46rnlF2+3McIWF++fMmdKtm3O9enVat242dGhfeiZpM0VpMVLRNpXkHTMf99lQlJXDVvyFGp+oMcTZuU1s7GppuYyc/qJ+/brt27d++eXnfX3nl5UlSltWSmpmK5U4GSnSxiql2FevKCuiJsqCfHw+rFu3zsKFM6VVohTtEmXHqhCl8ln08qEuO0WQGh+qlLgIsUc0xlcRNfFVnG25tjXPSNF2ezLc9ev7e/fuMX68Z0rK5qKiA2fOhAcFLezX7wlpS0WpcYctKdqmnksxiYFN3aNdp5jXbmXr1PlEjSE1atSo7MYThxX87Of3rYtLdw+PXhQCaWP1UjNbeWkfQZDiODpGWR41URbUo8fDy5fP7tnzEWmVKEW7RNmxKkSpfBYdfSjslKj+k878FsnW6e1DlcIe0TG+8qiJr+Jsy7WteUaKttuT4b7+etrw4a7SclFLl37eqdODtWvXor/Lln1hWbVy5VeUwKnqoYfabdjgbekOSpO04unKjhrMnfteSUmCdGRLKdpWKWjrbm44YKPTswGNXA/P+rmspFSsUuMT0RA6CA7+sVevxxs1urdFiybjxg3NytoplIsID3/91Ytu1e+55x56ePy46dVXBzVp0oh6vfKK66VL0cywosgt7u4uFAKxxJbfqO/69V8//vhDdG1LVatWfSV2sRxWGqzU1MAHHmhueYK4ejW2WbP7L1+uMEQ6gsxQilVWx7GUvlGWQU2USYcO/danT8/yW+fopKSNYrllQMVACwgNrIaJaWZrGQjdn3qqa716dR55pAOFlekrdLclfX34/zvl/oFHvJaV3ygTq7T7UGbFylQx42OPaImvDGriK87WSdczoS0p2m5PhuvevfPevWuk5YICAipeY92xY1le3h76S8dkp1AVHr64Q4cHaHBaDTSzdu1aie7Ys2cVrTP6m58fl5YWPHhwr3nzpkoHt5SibZWFtm5Ao4Eh7T0r/rNz7V57R356PfPyTXU+EQ2hg27dnMlwsjEjY9vYsUPGjHmBaSMcu7o+8+efYcJDsj0qallBwb6cnN3Tpr0+ceIr0i6iyPkUAuFYxm/Ut3371pbejohYzAxrK1gvvtiPLrHFZ6TrkgkThlvOQToxW0PJV0nHYaR7lG2hJsqk6dPH0JUZHSxa9PGMGWPFciagjF3yYRKb2VoGoaGLWrduFhKyKDd3z++/+9MpQNpXRrr7UNgpwW2GVfzf8zq940Z/UXQp+6YePpRZsTJV0qfAHmFjpgdq4ivO1knXM6EtKdpuT4ajC8krV2Kk5YJ69+4RGOgjPqTICddrpP79nxTDVn7r/UbRVDe35+Lj14tV6enhnTu3FR9alaJtdkBbN6iFR3T/SbR1K3TPc9ufG79tyTpFn1jGNTHRVyy/cGFH06aNmDbC8eHDftJxSHQWo/Ut7SKKNipdcgrHMn5zunUNJVaRtwcMeEqsEg5sBYuM7dKlg/hKAnWk626xmeUIomwNJV8lHYfRnYiyVdSs/OLi+Ecf7VRUdICOaQu0bduSSoQqJqCMXfJhsmwpynIZ0IWwv/930ja2+jK6Ez6s2CnNB29/dry4U3b0nhC5fINGH8qsWJkqsVwU9ggbMD1Qs0fE2Trpeia0JUXb9c9wjRv/w7KWjqlEOKZ7z+zsXZZVoql0g1+zZg0SIbzOQ8fSwS1Ftt3eXXdM/nX7+tV08WvQ/xGne+V9YhnXGzcO2qqyLBQ2uSCzeeuIEQObN2/sdAvRdssuomj3NmhQTziW8RsdM94m/zPDygTr6ae7BQUtpINTp0Lp0kRsw4wgSmYomSrpOIwUV7BeqFn5dN757LMJ4kO6JjWZFgjHTEAZu+TDJDaztQzoZG358pcoRe8JqoKdsrl+f79aLn4NlXeKvA9lVqxMlVguCnuEXd96oGaPiLN10vVMaEuKttuT4eRfpZSGSlw0VGUrw1HWPHcuUjqajBRts4OLUQmb6vahHRvY1H3rI6+ZWryQMndFVNAWRZ9YDZ5MFdPs+eefnjVr/NmzESUlCYWF+612ERUbu7pHj4eFYxm/Odm1e8U2vr7z+/atuIqcPfvdjRu/FdswI4iSGUqmSjoOozsRZauoWfmengOc/o74hjRjCPNQPkzisa1lQO7SmOGc9Pbhhcj9m+pU7JSglkPCuo4Kaql2p8j7UGbFylRZji8Ie4QNmB6o2SPibKXTtlrFNLO1BWxJ0XZ7Mty8eVNlPmlCt9viRVn5rRt/Na9SUpslSz6TjiYjRdsqC6U3/9q9KbeFtH0x/LHRp1eFlhUV31TnE6vBk6limjVsWP/q1VjhOCZmhdUugkpLD3p49Jo/f7rwUMZvTpJXYMTLTHFYmWDRCmvfvjWdKahE+qkf6cRkhpKpko7DSPco20IxyhcvRjVqdG9e3h6xJDd3D5UIb4YzhtSqVZMiJT6UD5N4bGsZ0LbftOl7aV/mWWxJdx9SevOr1dvU3COk3Uvhj41Rv1MUfSizYmWqxHJB2CMa42sLxfiWW8xWOm2rVUwzW1vAlhRttyfDUWp1cek+YcLwlJTNxcXx6ekV3xYQV0ZAgE+7dq3oicU3b8U1tHXrf2x90mT79l/ommX16jlZWTtpG1BLV9dnpE9tKUXbKsXFaLp760vXpLuGzsiMPGBZpcYnVoMnU8U0e+KJLj4+H+bnxyUkbOjataO0C/mZrmvoNEfr3vKT0DJ+o76Mt8PCfmaGlQlW+a0vLXXq9OCcOVPEElFSM2WGkqmSjsNI3yjLoBhl8sa4cUOZwrFjhwhf6mIMcXZuEx6+WHyVRj5MYi9by4Cc0KZNiy1bfqLccOSI/8iRblafxZb09eGt1zns3CmKPpRZsTJVwgH2iC7xlUExvuUWs5VO22oV08zWFrAlRdvtyXCkgoJ9X345qUuXDnXr1mnVqinzjW+6YqKo0wWm9BOxy5fPpiVVu3atzp3bMt8WoCellUc5nG7Y3d1dduxYJn1eSynaph7hWz4J73rnpZrZOnU+sRo8mSqmWWKi75NPdqlTpzat7EWLPrbsIlCvXh2q8vQcQE5jvkpiy29OFp+E7tixzYoVX1p9dplg0fn03nsbZGZutyyUjqBmKFtVVsexlI5Rlkcxyj16PEznSqYwMnKp8KUuxpDNm38gn9esWUMslwmT2MvWMhAGFD7vTtte+CCi1WexKh19qHGnKPpQZsXKVAlgj2iPrzyK8S23mK102larmGYyW8CqFG23M8NVBynaphIdf6mhWklxcSgqJGTRm28Ok5ZXpfSKsiIGjbIa6eXDO71TZFasTJUWaR8We+TuStF2ZDhlDOQTS2ncvRkZ2x57rHN6eri0qiqFKGuXUXwos2JlqrRI47DYI3ddirYjwyljIJ9YSsvupb4NG9YPDV0krapiIcraZRQfyqxYmSot0jIs9kh1kKLtyHDKGMgn/AlR1i74kG85cnwVbUeGU8ZAPuFPiLJ2wYd8y5Hjq2g7MpwyBvIJf0KUtQs+5FuOHF9F25HhlDGQT/gToqxd8CHfcuT4KtqODKeMgXzCnxBl7YIP+ZYjx1fRdmQ4ZQzkE/6EKGsXfMi3HDm+irYjwyljIJ/wJ0RZu+BDvuXI8VW0HRlOGQP5hD8hytoFH/ItR46vou3IcMoYyCf8CVHWLviQbzlyfBVtt57hFiyYST2ruWiS8rbphYF8wp8QZe2CD/mWI8dX0XbrGc5AyNimF4bzCX8gytqBD/nGkeMrYzub4XJzc2P+wtvb28vLa1b1ZunSpb6+viEhIXFxcWazmTFHFwznE/5AlLUDH/KNI8dXxnY2w1lC+dBkMlHPtdUYmh5NkqaalJR07tw51ga9MYRP+ANR1g58yDeOHF8Z2+UyXHx8PPWhxOhfjaHp0SRpqnRzmpWVxdqgN4bwCX8gytqBD/nGkeMrY7tchqPWlBLpvi+qGkPTo0nSVCl15+XlsTbojSF8wh+IsnbgQ75x5PjK2C6X4SgZUgez2ZxWjaHp0SRpqmRYUVERa4PeGMIn/IEoawc+5BtHjq+M7XIZDgAAADAuyHAAAAD4BBkOAAAAnyDDAQAA4JP/A5RVZ7uIKi3+AAAAAElFTkSuQmCC" class="uml" alt="uml diagram" title="" /></p>


<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
      this.page.url = 'https://avengerpenguin.com/infrastructure-sandwich/';
      this.page.identifier = 'infrastructure-sandwich';
    };

    (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://avengerpenguin.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>

	</main>

<script type="text/javascript">
const copyButtonLabel = "Copy";

let blocks = document.querySelectorAll("pre");

blocks.forEach((block) => {
  // only add button if browser supports Clipboard API
  if (navigator.clipboard) {
    let button = document.createElement("button");

    button.innerText = copyButtonLabel;
    block.appendChild(button);

    button.addEventListener("click", async () => {
      await copyCode(block, button);
    });
  }
});

async function copyCode(block, button) {
  let code = block.querySelector("code");
  let text = code.innerText;

  await navigator.clipboard.writeText(text);

  // visual feedback that task is completed
  button.innerText = "Copied";

  setTimeout(() => {
    button.innerText = copyButtonLabel;
  }, 2000);
}
</script>
</body>
</html>